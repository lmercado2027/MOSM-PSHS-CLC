<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update and/or Delete</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <div class="container-fluid" style="padding-top: 15px;">
        <div class="row">

            <div class="col-md-2">
                <button type="button" class="btn btn-primary left-align-button" onclick="goToLink('create')">Create</button>
                <br>
                <br>
                <button type="button" class="btn btn-primary left-align-button" onclick="goToLink('index')" style="width:90%;max-width: 128px;">Inventory</button>

                <br>
                <br>
            </div>

            <div class="col-md-8 rounded-background">
                <form onsubmit="return updateBatch()" method="post">
                    <nav class="navbar navbar-expand-md navbar-light">
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav mr-auto">
                            <li class="nav-item active">
                                <button type="button" class="btn btn-link-plain" onclick="goToLink('index')">back <span class="sr-only">(current)</span></button>
                            </li>

                            </ul>
                            <button type="submit" class="btn btn-primary">Update</button>
                            &nbsp;
                            <button type="button" class="btn btn-danger" onclick="deleteBatch()">Delete Batch</button>
                        </div>
                    </nav>

                    <h1 id="nameText">No Batch Selected</h1>
                    <p id="quantityDText">Ending Inventory: N/A</p>

                    <br>
                        <label for="quantityAInput">Beginning Inventory:</label>
                        <input class="roundedInputBox" type="number" min="1" step="1" id="quantityAInput" name="quantityAInput" required><br><br>
                        <label for="quantityBInput">Additional Inventory:</label>
                        <input class="roundedInputBox" type="number" min="0" step="1" id="quantityBInput" name="quantityBInput" required><br><br>
                        <label for="quantityCInput">Quantity Consumed:</label>
                        <input class="roundedInputBox" type="number" min="0" step="1" id="quantityCInput" name="quantityCInput" required><br><br>

                        <label for="dateAInput">Expiration Date:</label> 
                        <input class="roundedInputBox" type="date" id="dateAInput" name="dateAInput" required><br><br>

                        <div class="d-md-none">
                            <br>
                            <button type="button" class="btn btn-link-plain" onclick="goToLink('index')">back <span class="sr-only">(current)</span></button>
                            &nbsp;&nbsp;
                            <button type="submit" class="btn btn-primary">Update</button>
                            <button type="button" class="btn btn-danger" onclick="deleteBatch()">Delete Batch</button>
                            <br>
                            <br>
                        </div>
                </form>
            </div>
        </div>
    </div>

    <!-- <p id="quantityAText">Beginning Inventory: N/A</p>
    <p id="dateAText">Expiration Date (Initial Inventory): N/A</p>
    <p id="quantityBText">Additional Inventory: N/A</p>
    <p id="dateBText">Expiration Date (Additional Inventory): N/A</p>
    <p id="quantityCText">Quantity Consumed: N/A</p>

    Beginning Inventory: <input type="number" id="quantityAInput"><br>
    Expiration Date (Initial Inventory): <input type="text" id="dateAInput"><br>
    Additional Inventory: <input type="number" id="quantityBInput"><br> 
    Expiration Date (Additional Inventory): <input type="text" id="dateBInput"><br>
    Quantity Consumed: <input type="number" id="quantityCInput"><br> -->
    <!-- <button type="button" class="btn btn-primary" onclick="updateBatch()">Update Batch information</button> -->


    <script>

        function goToLink(input){
            window.location.replace(input+".html");
        }

        let database = JSON.parse(localStorage.getItem("2027_EMR")), id = -1
        function updateDetails() {
            let batch = database.batches[id]
            console.log(batch)
            $("#nameText")[0].innerText = batch.name
            // $("#quantityAText")[0].innerText = "Beginning Inventory: " + batch.start
            // $("#dateAText")[0].innerText = "Expiration Date (Initial Inventory): " + batch.expiryA
            // $("#quantityBText")[0].innerText = "Additional Inventory: " + batch.added
            // $("#dateBText")[0].innerText = "Expiration Date (Additional Inventory): " + (batch.expiryB ? batch.expiryB : "N/A")
            // $("#quantityCText")[0].innerText = "Quantity Consumed: " + batch.consumed
            $("#quantityDText")[0].innerText = "Ending Inventory: " + batch.end
            $("#quantityAInput")[0].value = batch.start
            $("#dateAInput")[0].value = batch.expiryA
            $("#quantityBInput")[0].value = batch.added
            //$("#dateBInput")[0].value = batch.expiryB
            $("#quantityCInput")[0].value = batch.consumed
        }
        function updateBatch() {
            if (id == -1) {
                return undefined
            }

            let confirmation = confirm("Are you sure you want to update this batch? This can't be undone.")

            if (!confirmation){
                return undefined
            }

            batch = database.batches[id]
            batch.start = Number($("#quantityAInput")[0].value)
            batch.expiryA = $("#dateAInput")[0].value
            batch.added = Number($("#quantityBInput")[0].value)
            //batch.expiryB = $("#dateBInput")[0].value
            batch.consumed = Number($("#quantityCInput")[0].value)
            batch.end = batch.start + batch.added - batch.consumed
            localStorage.setItem("2027_EMR", JSON.stringify(database))
            updateDetails()
        }
        function deleteBatch() {
            if (id == -1) {
                return undefined
            }

            let confirmation = confirm("Are you sure you want to delete this batch? This can't be undone.")

            if (!confirmation){
                return undefined
            }

            database.batches.splice(id, 1)
            localStorage.setItem("2027_EMR", JSON.stringify(database))
            if (history.length > 1) { // needs slight rework
                history.back()
            } else {
                ;
            }
        }

        //window.onload = function() {
            let url = document.location.href, params = url.split('?')[1].split('&'), data = {}, tmp
            for (let i = 0, l = params.length; i < l; i++) {
                tmp = params[i].split('=')
                data[tmp[0]] = tmp[1]
            }
            id = parseInt(data.id)
            updateDetails()
        //}
    </script>
</body>
</html>